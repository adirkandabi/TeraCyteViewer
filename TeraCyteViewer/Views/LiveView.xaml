<UserControl x:Class="TeraCyteViewer.Views.LiveView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:utils="clr-namespace:TeraCyteViewer.Utils"
             xmlns:views="clr-namespace:TeraCyteViewer.Views"
             FlowDirection="LeftToRight">

    <UserControl.Resources>
        <utils:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
        <utils:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <CubicEase x:Key="EaseOutCubic" EasingMode="EaseOut"/>
    </UserControl.Resources>



    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- HISTORY SIDEBAR -->
        <ScrollViewer Grid.Column="0" Width="180" Margin="0,0,10,0" VerticalScrollBarVisibility="Auto"
                     >
            <ItemsControl ItemsSource="{Binding History}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border BorderBrush="#444" BorderThickness="1" Margin="0,4,0,0" CornerRadius="4"
                                Cursor="Hand"
                                >
                            <Border.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation
                                                Storyboard.TargetProperty="Opacity"
                                                From="0" To="1"
                                                Duration="0:0:0.5"
                                                EasingFunction="{StaticResource EaseOutCubic}"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Border.Triggers>
                            <StackPanel MouseLeftButtonUp="HistoryItem_Click">
                                <Image Source="{Binding Image}" Height="80" Stretch="UniformToFill"/>
                                <TextBlock Text="{Binding Label}" FontWeight="SemiBold" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding Intensity, StringFormat=Intesity:{0:F1}}" FontSize="10" HorizontalAlignment="Center"/>
                                <TextBlock Text="{Binding Focus, StringFormat=Focus:{0:F2}}" FontSize="10" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>


        <!-- Image -->
        <Grid Grid.Column="1">
            <Border Background="#111" CornerRadius="8" Padding="8" Margin="0,0,10,0">
                <Image
                    Source="{Binding CurrentImage, NotifyOnTargetUpdated=True}"
                    Stretch="Uniform"
                    Opacity="{Binding IsStale, Converter={StaticResource BoolToOpacityConverter}}"
                    RenderTransformOrigin="0.5,0.5">    
                    <Image.RenderTransform>
                        <ScaleTransform ScaleX="0.98" ScaleY="0.98"/>
                    </Image.RenderTransform>

                    <Image.Triggers>
                       
                        <EventTrigger RoutedEvent="Binding.TargetUpdated">
                            <BeginStoryboard>
                                <Storyboard>
                                    <!-- Fade-in -->
                                    <DoubleAnimation
                                Storyboard.TargetProperty="Opacity"
                                From="0" To="1"
                                Duration="0:0:1.8"
                                EasingFunction="{StaticResource EaseOutCubic}"/>

                                  
                                    <DoubleAnimation
                                Storyboard.TargetProperty="RenderTransform.(ScaleTransform.ScaleX)"
                                From="0.98" To="1"
                                Duration="0:0:1.8"
                                EasingFunction="{StaticResource EaseOutCubic}"/>

                                    <DoubleAnimation
                                Storyboard.TargetProperty="RenderTransform.(ScaleTransform.ScaleY)"
                                From="0.98" To="1"
                                Duration="0:0:1.8"
                                EasingFunction="{StaticResource EaseOutCubic}"/>
                                </Storyboard>
                            </BeginStoryboard>
                        </EventTrigger>
                    </Image.Triggers>
                </Image>
            </Border>

            <!-- Overlay -->
            <Border Background="#AA000000" CornerRadius="8" Padding="10" Margin="0,0,10,0"
          VerticalAlignment="Center" HorizontalAlignment="Center"
          Visibility="{Binding ShowOverlay, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="{Binding OverlayMessage}" Foreground="White" FontWeight="SemiBold"/>
            </Border>
        </Grid>

        <!-- Info & Status -->
        <StackPanel Grid.Column="2" Margin="10,0,0,0" VerticalAlignment="Top">
            <Button Content="Refresh Now"
            Command="{Binding RefreshNowCommand}"
             IsEnabled="{Binding CanRefresh}"
            Padding="8"
            Margin="0,0,0,8"/>

            <TextBlock Text="{Binding ClassificationLabel}" FontSize="20" FontWeight="Bold" Margin="0,0,0,4"/>
            <TextBlock Text="{Binding IntensityAverage, StringFormat=Intensity Avg: {0:F2}}" Margin="0,0,0,4"/>
            <TextBlock Text="{Binding FocusScore, StringFormat=Focus Score: {0:F2}}" Margin="0,0,0,4"/>
            <TextBlock Text="{Binding ImageId, StringFormat=Image ID: {0}}" Margin="0,0,0,4"/>
            <TextBlock Text="{Binding LastUpdated, StringFormat=Updated: {0:HH:mm:ss}}" Margin="0,0,0,8"/>

            <Border Background="{Binding StatusBrush}"
        CornerRadius="6" Padding="6" Margin="0,8,0,0">
                <TextBlock Text="{Binding StatusMessage}"/>
            </Border>
            <TextBlock Text="Histogram" FontWeight="SemiBold" Margin="0,12,0,4"/>
            <views:HistogramView Data="{Binding Histogram}" Height="180" />
        </StackPanel>
    </Grid>

</UserControl>
